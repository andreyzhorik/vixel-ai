<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NOT AI ‚Äî GPTS</title>
<style>
  /* =============================
     Root variables & theme
     ============================= */
  :root {
    --bg: #0a0f1c;
    --panel: #10182a;
    --accent: #3b82f6;
    --accent-soft: #1d4ed8;
    --muted: #94a3b8;
    --text: #e5eaf5;
    --radius: 14px;
    --shadow: 0 10px 30px rgba(0,0,0,.3);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  }

  /* =============================
     Global styles
     ============================= */
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, var(--bg), #060b17);
    color: var(--text);
  }

  /* =============================
     App container
     ============================= */
  .app {
    width: 95%;
    max-width: 900px;
    height: 90vh;
    background: var(--panel);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.04);
  }

  /* =============================
     Header / branding / controls
     ============================= */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }

  .brand {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .logo {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent-soft));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    color: #fff;
  }

  .title {
    font-weight: 700;
    color: var(--accent);
  }

  .controls {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  select {
    background: rgba(255,255,255,0.03);
    color: var(--text);
    border: 1px solid rgba(255,255,255,0.06);
    padding: 8px 10px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
  }

  .btn {
    background: var(--accent);
    border: none;
    color: #fff;
    padding: 8px 12px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
  }

  /* =============================
     Chat window
     ============================= */
  .chat {
    flex: 1;
    overflow: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .msg {
    max-width: 78%;
    padding: 12px 16px;
    border-radius: 12px;
    line-height: 1.5;
    box-shadow: 0 6px 18px rgba(0,0,0,0.3);
    word-break: break-word;
    white-space: pre-wrap;
  }

  .msg.user {
    align-self: flex-end;
    background: linear-gradient(135deg, var(--accent-soft), var(--accent));
    color: #fff;
    border-bottom-right-radius: 6px;
  }

  .msg.assistant {
    align-self: flex-start;
    background: #111827;
    color: var(--text);
    border-bottom-left-radius: 6px;
  }

  /* =============================
     Inline and block code styling
     ============================= */
  .msg code {
    background: #1e293b;
    padding: 2px 5px;
    border-radius: 4px;
    font-family: monospace;
    color: #93c5fd;
  }

  .msg pre {
    background: #1e293b;
    padding: 10px;
    border-radius: 8px;
    overflow-x: auto;
    font-family: monospace;
    color: #93c5fd;
    position: relative;
  }

  /* =============================
     Footer & input
     ============================= */
  footer {
    display: flex;
    gap: 10px;
    padding: 14px;
    border-top: 1px solid rgba(255,255,255,0.04);
    background: #0d1525;
  }

  textarea {
    flex: 1;
    min-height: 56px;
    border-radius: 10px;
    padding: 12px;
    background: #0c1222;
    border: 1px solid rgba(255,255,255,0.06);
    color: var(--text);
    resize: none;
    font-size: 14px;
    font-family: inherit;
  }

  button.send {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 12px 18px;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
  }

  .small {
    font-size: 12px;
    color: var(--muted);
  }

  /* =============================
     Typing indicator
     ============================= */
  .typing {
    width: 48px;
    height: 18px;
    border-radius: 12px;
    background: #162037;
    display: flex;
    gap: 6px;
    align-items: center;
    padding: 6px;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--muted);
    animation: blink 1s infinite;
  }

  .dot:nth-child(2) { animation-delay: .15s; }
  .dot:nth-child(3) { animation-delay: .3s; }

  @keyframes blink {
    0% { opacity: .15; }
    50% { opacity: 1; }
    100% { opacity: .15; }
  }

  /* =============================
     Assistant message enhancements
     ============================= */
  .msg.assistant code.inline {
    background: #1a2335;
    color: #facc15;
    padding: 2px 5px;
    border-radius: 5px;
    font-family: monospace;
  }

  .msg.assistant pre code {
    display: block;
    background: #0f172a;
    padding: 10px;
    border-radius: 10px;
    overflow-x: auto;
  }

  .msg.assistant h1,
  .msg.assistant h2,
  .msg.assistant h3,
  .msg.assistant h4,
  .msg.assistant h5,
  .msg.assistant h6 {
    margin: 6px 0;
    color: #60a5fa;
  }

  .msg.assistant blockquote {
    border-left: 3px solid #3b82f6;
    margin: 8px 0;
    padding-left: 10px;
    color: #9ca3af;
    font-style: italic;
  }

  .msg.assistant ul,
  .msg.assistant ol {
    margin: 4px 0 4px 20px;
  }

  .msg.assistant hr {
    border: 0;
    border-top: 1px solid #334155;
    margin: 10px 0;
  }

  /* =============================
     Copy button
     ============================= */
  .copy-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(30,41,59,0.95);
    color: #fff;
    border: none;
    padding: 4px 8px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    z-index: 10;
    opacity: 0.85;
  }

  /* =============================
     Responsive
     ============================= */
  @media (max-width: 640px) {
    .app {
      height: 100vh;
      border-radius: 0;
    }
  }

</style>
</head>
<body>

<div class="app">
  <header>
    <div class="brand">
      <div class="logo">N-A</div>
      <div>
        <div class="title">NOT AI</div>
        <div class="small">Private Local Chat</div>
      </div>
    </div>
    <div class="controls">
      <label class="small" for="provider">Model</label>
      <select id="provider"></select>
      <button class="btn" id="clearBtn">Clear</button>
    </div>
  </header>

  <main class="chat" id="chat"></main>

  <footer>
    <textarea id="prompt" placeholder="Type your message..."></textarea>
    <button class="send" id="sendBtn">Send</button>
  </footer>
</div>

<script>
(() => {
  // --------------------------
  // API Endpoints
  // --------------------------
  const PRIMARY_API = "https://plain-pine-b32a.mrviktor2426.workers.dev/";
  const BACKUP_API  = "https://wispy-voice-741d.mrviktor2426.workers.dev/";

  const providerSel = document.getElementById("provider");
  const chatEl = document.getElementById("chat");
  const promptEl = document.getElementById("prompt");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");

  // --------------------------
  // Populate model dropdown
  // --------------------------
  providerSel.innerHTML = `
    <option value="gpt-4o-mini">GPT-4o-mini (free and fast ‚è©)</option>
    <option value="gpt-4.1-mini" data-locked="true">GPT-4.1-mini (locked and good ü§î)</option>
    <option value="gemini-2.5-flash">Gemini 2.5 Flash (free and nerd ü§ì)</option>
    <option value="gemini-2.5-pro" data-locked="true">Gemini 2.5 Pro (locked and very smart üß†)</option>
  `;

  // --------------------------
  // Markdown to HTML conversion
  // --------------------------
  function markdownToHTML(md) {
    if (!md) return "";
    md = md.replace(/</g, "&lt;").replace(/>/g, "&gt;");

    const codeBlocks = [];
    md = md.replace(/```([\s\S]*?)```/g, (match, code) => {
      const id = codeBlocks.length;
      codeBlocks.push(code);
      return `@@CODE_BLOCK_${id}@@`;
    });

    // Headings
    md = md.replace(/^###### (.*$)/gim, '<h6>$1</h6>')
           .replace(/^##### (.*$)/gim, '<h5>$1</h5>')
           .replace(/^#### (.*$)/gim, '<h4>$1</h4>')
           .replace(/^### (.*$)/gim, '<h3>$1</h3>')
           .replace(/^## (.*$)/gim, '<h2>$1</h2>')
           .replace(/^# (.*$)/gim, '<h1>$1</h1>');

    // Horizontal rules
    md = md.replace(/(^|\n)---(\n|$)/g, '\n<hr>\n');

    // Blockquotes
    md = md.replace(/(^|\n)> (.*)/g, '$1<blockquote>$2</blockquote>');

    // Restore code blocks
    md = md.replace(/@@CODE_BLOCK_(\d+)@@/g, (m, idx) => {
      const code = codeBlocks[Number(idx)] || "";
      return `<pre><code>${code.replace(/&lt;/g,'<').replace(/&gt;/g,'>')}</code></pre>`;
    });

    return `<p>${md}</p>`;
  }

  // --------------------------
  // Append message and copy buttons
  // --------------------------
  function appendMsg(text, role) {
    const div = document.createElement("div");
    div.className = `msg ${role}`;
    div.innerHTML = markdownToHTML(text);
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
    addCopyButtonsForNode(div);
  }

  function addCopyButtonsForNode(root) {
    if (!root) return;
    root.querySelectorAll('pre').forEach(pre => {
      if (pre.dataset.copyAttached) return;
      const code = pre.querySelector('code');
      if (!code) return;
      const btn = document.createElement('button');
      btn.className = 'copy-btn';
      btn.type = 'button';
      btn.textContent = 'üìã Copy';
      btn.title = 'Copy code';
      pre.style.position = 'relative';
      pre.appendChild(btn);
      btn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(code.innerText);
          btn.textContent = '‚úÖ Copied';
          setTimeout(()=>btn.textContent='üìã Copy',1400);
        } catch (e) {
          btn.textContent = '‚ùå';
          setTimeout(()=>btn.textContent='üìã Copy',1200);
        }
      });
      pre.dataset.copyAttached = '1';
    });
  }

  const mo = new MutationObserver(muts => {
    muts.forEach(m => {
      m.addedNodes.forEach(n => {
        if (n.nodeType === 1) addCopyButtonsForNode(n);
      });
    });
  });
  mo.observe(chatEl, { childList:true, subtree:true });

  // --------------------------
  // Worker call
  // --------------------------
  async function callWorker(baseUrl, provider, messages) {
    try {
      const res = await fetch(baseUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ provider, messages })
      });
      const txt = await res.text();
      try { return JSON.parse(txt); } catch(e) { return { error: "Invalid JSON", raw: txt }; }
    } catch (err) { return { error: err.message || String(err) }; }
  }

  // --------------------------
  // Send message workflow
  // --------------------------
  async function sendMessage(text) {
    const model = providerSel.value;
    appendMsg(text, "user");
    showTyping();

    const primaryResp = await callWorker(PRIMARY_API, model, [{ role:"user", content:text }]);
    hideTyping();

    const primaryText = primaryResp && typeof primaryResp.output_text === "string" ? primaryResp.output_text : null;
    const primaryNoReply = primaryText && primaryText.trim().startsWith("‚ö†Ô∏è No reply");

    if (primaryNoReply) {
      showTyping();
      const backupResp = await callWorker(BACKUP_API, model, [{ role:"user", content:text }]);
      hideTyping();
      const backupText = backupResp && typeof backupResp.output_text === "string" ? backupResp.output_text : null;
      if (backupText) {
        appendMsg(`‚ö†Ô∏è Primary server failed ‚Äî using backup. ${model.replace(/-/g," ")}`, "assistant");
        appendMsg(backupText, "assistant");
        return;
      } else appendMsg(`‚ùå Both servers failed: ${backupResp?.error || "No response from backup"}`, "assistant");
      return;
    }

    if (primaryText) appendMsg(primaryText,"assistant");
    else appendMsg(`‚ùå Primary server error: ${primaryResp?.error || "Unknown error"}`, "assistant");
  }

  // --------------------------
  // Typing indicator helpers
  // --------------------------
  function showTyping() {
    if(document.getElementById("typingIndicator")) return;
    const wrap = document.createElement("div");
    wrap.className = "msg assistant";
    wrap.id = "typingIndicator";
    wrap.innerHTML = '<div class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }
  function hideTyping() {
    const el = document.getElementById("typingIndicator");
    if(el) el.remove();
  }

  // --------------------------
  // Event listeners
  // --------------------------
  sendBtn.onclick = () => {
    const txt = promptEl.value.trim();
    if (!txt) return;
    promptEl.value = "";
    sendMessage(txt);
  };

  promptEl.addEventListener("keydown", e => {
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
  });

  clearBtn.onclick = () => chatEl.innerHTML = "";

})();
</script>
</body>
</html>
