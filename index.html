<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NOT AI ‚Äî GPTS</title>
<style>
  :root{
    --bg:#0a0f1c; --panel:#10182a; --accent:#3b82f6; --accent-soft:#1d4ed8;
    --muted:#94a3b8; --text:#e5eaf5; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.3);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg,var(--bg),#060b17);color:var(--text)}
  .app{width:95%;max-width:900px;height:90vh;background:var(--panel);border-radius:var(--radius);
    box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
  header{display:flex;align-items:center;justify-content:space-between;padding:18px;border-bottom:1px solid rgba(255,255,255,0.04)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-soft));
    display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
  .title{font-weight:700;color:var(--accent)}
  .controls{display:flex;gap:10px;align-items:center}
  select{background:rgba(255,255,255,0.03);color:var(--text);border:1px solid rgba(255,255,255,0.06);
    padding:8px 10px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn{background:var(--accent);border:none;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .chat{flex:1;overflow:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
  .msg{max-width:78%;padding:12px 16px;border-radius:12px;line-height:1.5;box-shadow:0 6px 18px rgba(0,0,0,0.3)}
  .msg.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent-soft),var(--accent));color:#fff;border-bottom-right-radius:6px}
  .msg.assistant{align-self:flex-start;background:#111827;color:var(--text);border-bottom-left-radius:6px}
  .msg strong{color:#fff;font-weight:700}
  .msg em{font-style:italic;color:#cbd5e1}
  .msg code{background:#1e293b;padding:2px 5px;border-radius:4px;font-family:monospace;color:#93c5fd}
  .msg pre{background:#1e293b;padding:10px;border-radius:8px;overflow-x:auto;font-family:monospace;color:#93c5fd}
  .msg ul{margin:6px 0;padding-left:20px}
  .msg li{margin:3px 0}
  .meta{font-size:12px;color:var(--muted);margin-top:6px}
  footer{display:flex;gap:10px;padding:14px;border-top:1px solid rgba(255,255,255,0.04);background:#0d1525}
  textarea{flex:1;min-height:56px;border-radius:10px;padding:12px;background:#0c1222;border:1px solid rgba(255,255,255,0.06);color:var(--text);resize:none}
  button.send{background:var(--accent);color:#fff;border:none;padding:12px 18px;border-radius:10px;font-weight:700;cursor:pointer}
  .small{font-size:12px;color:var(--muted)}
  .typing{width:48px;height:18px;border-radius:12px;background:#162037;display:flex;gap:6px;align-items:center;padding:6px}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--muted);animation:blink 1s infinite}
  .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
  @keyframes blink{0%{opacity:.15}50%{opacity:1}100%{opacity:.15}}
  @media (max-width:640px){.app{height:100vh;border-radius:0}}
  .msg.assistant code.inline {
  background: #1a2335;
  color: #facc15;
  padding: 2px 5px;
  border-radius: 5px;
  font-family: monospace;
}
.msg.assistant pre code {
  display: block;
  background: #0f172a;
  padding: 10px;
  border-radius: 10px;
  overflow-x: auto;
}
.msg.assistant h1, h2, h3, h4, h5, h6 {
  margin: 6px 0;
  color: #60a5fa;
}
.msg.assistant blockquote {
  border-left: 3px solid #3b82f6;
  margin: 8px 0;
  padding-left: 10px;
  color: #9ca3af;
  font-style: italic;
}
.msg.assistant ul, .msg.assistant ol {
  margin: 4px 0 4px 20px;
}
.msg.assistant hr {
  border: 0;
  border-top: 1px solid #334155;
  margin: 10px 0;
}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">N-A</div>
        <div>
          <div class="title">NOT AI</div>
          <div class="small">Private Local Chat</div>
        </div>
      </div>
      <div class="controls">
        <label class="small" for="provider">Model</label>
        <select id="provider"></select>
        <button class="btn" id="clearBtn">Clear</button>
      </div>
    </header>

    <main class="chat" id="chat"></main>

    <footer>
      <textarea id="prompt" placeholder="Type your message..."></textarea>
      <button class="send" id="sendBtn">Send</button>
    </footer>
  </div>

<script>
(() => {
  const PRIMARY_API = "https://plain-pine-b32a.mrviktor2426.workers.dev/";
  const BACKUP_API  = "https://wispy-voice-741d.mrviktor2426.workers.dev/";

  const providerSel = document.getElementById("provider");
  const chatEl = document.getElementById("chat");
  const promptEl = document.getElementById("prompt");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");

  providerSel.innerHTML = `
    <option value="gpt-4o-mini">GPT-4o-mini (free and fast ‚è©)</option>
    <option value="gpt-4o" data-locked="true">GPT-4o (locked and very good üß†)</option>
    <option value="gpt-4.1-mini" data-locked="true">GPT-4.1-mini (locked and good ü§î)</option>
    <option value="gemini-2.5-flash">Gemini 2.5 Flash (DA NERD ü§ì)</option>
    <option value="deepseek">DeepSeek (da idiot that does not work üíÄ)</option>
  `;

  // -----------------------
  // Safe Markdown -> HTML
  // Code blocks are extracted first so other regexes won't touch them
  // -----------------------
  function markdownToHTML(md) {
    if (!md) return "";

    // escape HTML
    md = md.replace(/</g, "&lt;").replace(/>/g, "&gt;");

    // Extract fenced code blocks and replace them with placeholders
    const codeBlocks = [];
    md = md.replace(/```([\s\S]*?)```/g, (match, code) => {
      const id = codeBlocks.length;
      codeBlocks.push(code);
      return `@@CODE_BLOCK_${id}@@`;
    });

    // Headings
    md = md.replace(/^###### (.*$)/gim, '<h6>$1</h6>');
    md = md.replace(/^##### (.*$)/gim, '<h5>$1</h5>');
    md = md.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
    md = md.replace(/^### (.*$)/gim, '<h3>$1</h3>');
    md = md.replace(/^## (.*$)/gim, '<h2>$1</h2>');
    md = md.replace(/^# (.*$)/gim, '<h1>$1</h1>');

    // Horizontal rule
    md = md.replace(/(^|\n)---(\n|$)/g, '\n<hr>\n');

    // Blockquotes
    md = md.replace(/(^|\n)> (.*)/g, '$1<blockquote>$2</blockquote>');

    // Ordered lists
    // Convert contiguous lines starting with "1. " etc into a single <ol>
    md = md.replace(/(^|\n)(\d+\.\s+.+(\n\d+\.\s+.+)*)/g, (m, p1, group) => {
      const items = group.trim().split(/\n+/).map(line => line.replace(/^\d+\.\s+/, ''));
      return p1 + '<ol>' + items.map(i => `<li>${i}</li>`).join('') + '</ol>';
    });

    // Unordered lists (- or *)
    md = md.replace(/(^|\n)(([-*]\s+.+)(\n[-*]\s+.+)*)/g, (m, p1, group) => {
      // ignore lists that are inside code placeholders
      if (/@@CODE_BLOCK_\d+@@/.test(group)) return m;
      const items = group.trim().split(/\n+/).map(line => line.replace(/^[-*]\s+/, ''));
      return p1 + '<ul>' + items.map(i => `<li>${i}</li>`).join('') + '</ul>';
    });

    // Bold and Italic
    md = md.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    md = md.replace(/(^|[^*])\*(?!\*)([^*]+)\*(?!\*)/g, '$1<em>$2</em>');
    md = md.replace(/(^|[^_])_(?!_)([^_]+)_(?!_)/g, '$1<em>$2</em>');

    // Inline code (only single backticks)
    md = md.replace(/`([^`\n]+)`/g, '<code class="inline">$1</code>');

    // Links [text](url)
    md = md.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

    // Paragraphs and line breaks
    // Convert two or more newlines into paragraph separation
    md = md.replace(/\n{2,}/g, '</p><p>');
    md = md.replace(/\n/g, '<br>');

    // Wrap in paragraph if not heading/blockquote/list/hr already
    md = `<p>${md}</p>`;
    md = md.replace(/<p>(<(h\d|ul|ol|blockquote|pre|hr)[\s\S]*?>[\s\S]*?<\/\2>)<\/p>/g, '$1'); // unwrap block elements

    // Restore code blocks
    md = md.replace(/@@CODE_BLOCK_(\d+)@@/g, (m, idx) => {
      const code = codeBlocks[Number(idx)] || "";
      // do not escape code content further ‚Äî keep original spacing/newlines
      return `<pre><code>${code.replace(/&lt;/g,'<').replace(/&gt;/g,'>')}</code></pre>`;
    });

    return md;
  }

  // -----------------------
  // Append message and then add copy buttons to code blocks
  // -----------------------
  function appendMsg(text, role) {
    const div = document.createElement("div");
    div.className = `msg ${role}`;
    div.innerHTML = markdownToHTML(text);
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;

    // After adding, ensure copy buttons are attached
    addCopyButtonsForNode(div);
  }

  // -----------------------
  // Copy button logic
  // - Adds a small button to each <pre><code> if not already added
  // - Uses innerText for copy to preserve whitespace/formatting
  // -----------------------
  function addCopyButtonsForNode(root) {
    if (!root) return;
    root.querySelectorAll('pre').forEach(pre => {
      if (pre.dataset.copyAttached) return; // skip duplicates
      const code = pre.querySelector('code');
      if (!code) return;

      // Create button
      const btn = document.createElement('button');
      btn.className = 'copy-btn';
      btn.type = 'button';
      btn.textContent = 'üìã Copy';
      btn.title = 'Copy code';

      // Style (inline so it's easy to drop in)
      btn.style.position = 'absolute';
      btn.style.top = '8px';
      btn.style.right = '8px';
      btn.style.background = 'rgba(30,41,59,0.95)';
      btn.style.color = '#fff';
      btn.style.border = 'none';
      btn.style.padding = '4px 8px';
      btn.style.borderRadius = '6px';
      btn.style.cursor = 'pointer';
      btn.style.fontSize = '12px';
      btn.style.zIndex = '10';
      btn.style.opacity = '0.85';

      // wrap pre so we can position the button inside
      pre.style.position = 'relative';
      pre.appendChild(btn);

      // Click action: copy the code text preserving whitespace
      btn.addEventListener('click', async () => {
        try {
          const textToCopy = code.innerText;
          await navigator.clipboard.writeText(textToCopy);
          const prev = btn.textContent;
          btn.textContent = '‚úÖ Copied';
          setTimeout(() => btn.textContent = 'üìã Copy', 1400);
        } catch (e) {
          console.error('Copy failed', e);
          btn.textContent = '‚ùå';
          setTimeout(() => btn.textContent = 'üìã Copy', 1200);
        }
      });

      pre.dataset.copyAttached = '1';
    });
  }

  // MutationObserver: For safety, auto-attach to any new assistant node added (optional but robust)
  const mo = new MutationObserver(muts => {
    muts.forEach(m => {
      m.addedNodes.forEach(node => {
        if (node.nodeType === 1) addCopyButtonsForNode(node);
      });
    });
  });
  mo.observe(chatEl, { childList: true, subtree: true });

  // -----------------------
  // Worker caller (unchanged behavior from your last working copy)
  // -----------------------
  async function callWorker(baseUrl, provider, messages) {
    try {
      const res = await fetch(baseUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ provider, messages }),
      });
      const txt = await res.text();
      try {
        return JSON.parse(txt);
      } catch (e) {
        return { error: "Invalid JSON from worker", raw: txt };
      }
    } catch (err) {
      return { error: err.message || String(err) };
    }
  }

  async function sendMessage(text) {
    const model = providerSel.value;
    appendMsg(text, "user");
    showTyping();

    const primaryResp = await callWorker(PRIMARY_API, model, [{ role: "user", content: text }]);
    hideTyping();

    const primaryText = primaryResp && typeof primaryResp.output_text === "string" ? primaryResp.output_text : null;
    const primarySaysNoReply = primaryText && primaryText.trim().startsWith("‚ö†Ô∏è No reply");

    if (primarySaysNoReply) {
      showTyping();
      const backupResp = await callWorker(BACKUP_API, model, [{ role: "user", content: text }]);
      hideTyping();

      const backupText = backupResp && typeof backupResp.output_text === "string" ? backupResp.output_text : null;

      if (backupText) {
        const friendlyModelName = (model || "gpt-4o-mini").replace(/-/g, " ");
        appendMsg(`‚ö†Ô∏è Primary server failed ‚Äî using backup. ${friendlyModelName}`, "assistant");
        appendMsg(backupText, "assistant");
        return;
      } else {
        const backupErr = backupResp?.error || "No response from backup";
        appendMsg(`‚ùå Both servers failed: ${backupErr}`, "assistant");
        return;
      }
    }

    if (primaryText) {
      appendMsg(primaryText, "assistant");
    } else {
      const errMsg = primaryResp?.error || "Unknown error from primary";
      appendMsg(`‚ùå Primary server error: ${errMsg}`, "assistant");
    }
  }

  // show/hide typing helpers (copied from your code)
  function showTyping() {
    if (document.getElementById("typingIndicator")) return;
    const wrap = document.createElement("div");
    wrap.className = "msg assistant";
    wrap.id = "typingIndicator";
    wrap.innerHTML = '<div class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function hideTyping() {
    const el = document.getElementById("typingIndicator");
    if (el) el.remove();
  }

  sendBtn.onclick = () => {
    const txt = promptEl.value.trim();
    if (!txt) return;
    promptEl.value = "";
    sendMessage(txt);
  };

  promptEl.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  clearBtn.onclick = () => (chatEl.innerHTML = "");
})();
</script>
</body>
</html>
