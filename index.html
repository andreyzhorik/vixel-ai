<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Worker Chat UI</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#071027;color:#e6eef8}
    .container{max-width:900px;margin:18px auto;display:flex;flex-direction:column;height:calc(100vh-36px);border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#071827,#041023);border:1px solid rgba(255,255,255,0.03)}
    header{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center}
    header h1{font-size:1rem;margin:0}
    main{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:12px}
    .msg{max-width:78%;padding:10px 14px;border-radius:12px;white-space:pre-wrap}
    .user{align-self:flex-end;background:#1d4ed8;color:#fff;border-bottom-right-radius:6px}
    .assistant{align-self:flex-start;background:#0f1726;color:#e6eef8;border-bottom-left-radius:6px}
    footer{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.02)}
    textarea{flex:1;min-height:48px;max-height:160px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#041326;color:#e6eef8;resize:vertical}
    button{padding:10px 12px;border-radius:8px;border:none;background:#2563eb;color:#fff;cursor:pointer}
    .muted{color:#94a3b8;font-size:0.9rem}
    .small{font-size:0.85rem;color:#94a3b8}
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="Chat UI">
    <header>
      <div>
        <h1>Worker Chat</h1>
        <div class="small">This HTML expects a worker endpoint at /api on the same origin.</div>
      </div>
      <div class="small muted" id="userId">user: â€”</div>
    </header>

    <main id="chat" aria-live="polite"></main>

    <footer>
      <textarea id="input" placeholder="Type a message (Enter to send, Shift+Enter newline)"></textarea>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button id="send">Send</button>
        <button id="clear" style="background:#dc2626">Clear</button>
      </div>
    </footer>
  </div>

<script>
(() => {
  const chatEl = document.getElementById('chat');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('send');
  const clearBtn = document.getElementById('clear');
  const userIdEl = document.getElementById('userId');

  // simple persistent user id and memory in localStorage
  let userId = localStorage.getItem('wc_user_id');
  if (!userId) { userId = crypto.randomUUID(); localStorage.setItem('wc_user_id', userId); }
  userIdEl.textContent = 'user: ' + userId.slice(0,8);

  let memory = JSON.parse(localStorage.getItem('wc_memory') || '[]');
  renderMemory();

  sendBtn.addEventListener('click', send);
  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
  });
  clearBtn.addEventListener('click', () => {
    if (!confirm('Clear local chat memory?')) return;
    memory = []; localStorage.removeItem('wc_memory'); renderMemory();
    // optionally notify worker to reset server-side memory
    fetch('/api', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ user_id: userId, reset: true })
    }).catch(()=>{/* ignore errors */});
  });

  async function send() {
    const text = inputEl.value.trim();
    if (!text) return;
    appendMessage('user', text);
    memory.push({ role: 'user', content: text, ts: Date.now() });
    inputEl.value = '';
    saveMemory();

    const thinkingEl = appendMessage('assistant', 'Thinking...');
    try {
      const res = await fetch('/api', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          user_id: userId,
          messages: [{ role: 'user', content: text }],
          reset: false
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        throw new Error('Worker error: ' + res.status + ' ' + txt);
      }

      const data = await res.json();
      // Expect OpenAI-style chat completion JSON: choices[0].message.content
      const assistantText = data?.choices?.[0]?.message?.content
                          || data?.message?.content
                          || data?.output
                          || JSON.stringify(data);
      updateMessage(thinkingEl, assistantText);
      memory.push({ role: 'assistant', content: assistantText, ts: Date.now() });
      saveMemory();
    } catch (err) {
      updateMessage(thinkingEl, 'Error: ' + (err.message || err));
    }
  }

  function appendMessage(role, text) {
    const el = document.createElement('div');
    el.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
    el.textContent = text;
    chatEl.appendChild(el);
    chatEl.scrollTop = chatEl.scrollHeight;
    return el;
  }

  function updateMessage(el, text) {
    if (!el) return;
    el.textContent = text;
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function renderMemory() {
    chatEl.innerHTML = '';
    memory.forEach(m => {
      const role = m.role === 'user' ? 'user' : 'assistant';
      const d = document.createElement('div');
      d.className = 'msg ' + role;
      d.textContent = m.content;
      chatEl.appendChild(d);
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function saveMemory() {
    try { localStorage.setItem('wc_memory', JSON.stringify(memory)); } catch(e){/* ignore */ }
  }
})();
</script>
</body>
</html>
