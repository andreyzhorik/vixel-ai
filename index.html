<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NOT AI — GPTS</title>
<style>
  :root{
    --bg:#0a0f1c; --panel:#10182a; --accent:#3b82f6; --accent-soft:#1d4ed8;
    --muted:#94a3b8; --text:#e5eaf5; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.3);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg,var(--bg),#060b17);color:var(--text)}
  .app{width:95%;max-width:900px;height:90vh;background:var(--panel);border-radius:var(--radius);
    box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
  header{display:flex;align-items:center;justify-content:space-between;padding:18px;border-bottom:1px solid rgba(255,255,255,0.04)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-soft));
    display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
  .title{font-weight:700;color:var(--accent)}
  .controls{display:flex;gap:10px;align-items:center}
  select{background:rgba(255,255,255,0.03);color:var(--text);border:1px solid rgba(255,255,255,0.06);
    padding:8px 10px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn{background:var(--accent);border:none;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .chat{flex:1;overflow:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
  .msg{max-width:78%;padding:12px 16px;border-radius:12px;line-height:1.5;box-shadow:0 6px 18px rgba(0,0,0,0.3)}
  .msg.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent-soft),var(--accent));color:#fff;border-bottom-right-radius:6px}
  .msg.assistant{align-self:flex-start;background:#111827;color:var(--text);border-bottom-left-radius:6px}
  .msg strong{color:#fff;font-weight:700}
  .msg em{font-style:italic;color:#cbd5e1}
  .msg code{background:#1e293b;padding:2px 5px;border-radius:4px;font-family:monospace;color:#93c5fd}
  .msg pre{background:#1e293b;padding:10px;border-radius:8px;overflow-x:auto;font-family:monospace;color:#93c5fd}
  .msg ul{margin:6px 0;padding-left:20px}
  .msg li{margin:3px 0}
  .meta{font-size:12px;color:var(--muted);margin-top:6px}
  footer{display:flex;gap:10px;padding:14px;border-top:1px solid rgba(255,255,255,0.04);background:#0d1525}
  textarea{flex:1;min-height:56px;border-radius:10px;padding:12px;background:#0c1222;border:1px solid rgba(255,255,255,0.06);color:var(--text);resize:none}
  button.send{background:var(--accent);color:#fff;border:none;padding:12px 18px;border-radius:10px;font-weight:700;cursor:pointer}
  .small{font-size:12px;color:var(--muted)}
  .typing{width:48px;height:18px;border-radius:12px;background:#162037;display:flex;gap:6px;align-items:center;padding:6px}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--muted);animation:blink 1s infinite}
  .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
  @keyframes blink{0%{opacity:.15}50%{opacity:1}100%{opacity:.15}}
  @media (max-width:640px){.app{height:100vh;border-radius:0}}
  .msg.assistant code.inline {
  background: #1a2335;
  color: #facc15;
  padding: 2px 5px;
  border-radius: 5px;
  font-family: monospace;
}
.msg.assistant pre code {
  display: block;
  background: #0f172a;
  padding: 10px;
  border-radius: 10px;
  overflow-x: auto;
}
.msg.assistant h1, h2, h3, h4, h5, h6 {
  margin: 6px 0;
  color: #60a5fa;
}
.msg.assistant blockquote {
  border-left: 3px solid #3b82f6;
  margin: 8px 0;
  padding-left: 10px;
  color: #9ca3af;
  font-style: italic;
}
.msg.assistant ul, .msg.assistant ol {
  margin: 4px 0 4px 20px;
}
.msg.assistant hr {
  border: 0;
  border-top: 1px solid #334155;
  margin: 10px 0;
}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">N-A</div>
        <div>
          <div class="title">NOT AI</div>
          <div class="small">Private Local Chat</div>
        </div>
      </div>
      <div class="controls">
        <label class="small" for="provider">Model</label>
        <select id="provider"></select>
        <button class="btn" id="clearBtn">Clear</button>
      </div>
    </header>

    <main class="chat" id="chat"></main>

    <footer>
      <textarea id="prompt" placeholder="Type your message..."></textarea>
      <button class="send" id="sendBtn">Send</button>
    </footer>
  </div>

<script>
(() => {
  const PRIMARY_API = "https://plain-pine-b32a.mrviktor2426.workers.dev/";
  const BACKUP_API  = "https://wispy-voice-741d.mrviktor2426.workers.dev/";

  const providerSel = document.getElementById("provider");
  const chatEl = document.getElementById("chat");
  const promptEl = document.getElementById("prompt");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");

  providerSel.innerHTML = `
    <option value="gpt-4o-mini">GPT-4o-mini</option>
    <option value="gpt-4o" data-locked="true">GPT-4o (locked)</option>
    <option value="gpt-4.1-mini" data-locked="true">GPT-4.1-mini (locked)</option>
    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
    <option value="deepseek">DeepSeek</option>
  `;

  function markdownToHTML(md) {
  if (!md) return "";

  // Escape < and > so markdown can’t inject HTML
  md = md.replace(/</g, "&lt;").replace(/>/g, "&gt;");

  // Code blocks ```
  md = md.replace(/```([\s\S]*?)```/g, (_, code) => `<pre><code>${code.trim()}</code></pre>`);

  // Headings ####, ###, ##, #
  md = md.replace(/^###### (.*$)/gim, '<h6>$1</h6>');
  md = md.replace(/^##### (.*$)/gim, '<h5>$1</h5>');
  md = md.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
  md = md.replace(/^### (.*$)/gim, '<h3>$1</h3>');
  md = md.replace(/^## (.*$)/gim, '<h2>$1</h2>');
  md = md.replace(/^# (.*$)/gim, '<h1>$1</h1>');

  // Horizontal rule ---
  md = md.replace(/^---$/gim, '<hr>');

  // Blockquotes >
  md = md.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');

  // Ordered lists 1. item
  md = md.replace(/^\d+\.\s+(.*$)/gim, '<ol><li>$1</li></ol>');
  md = md.replace(/<\/ol>\s*<ol>/gim, ''); // merge adjacent lists

  // Unordered lists - item or * item
  md = md.replace(/^[-*]\s+(.*$)/gim, '<ul><li>$1</li></ul>');
  md = md.replace(/<\/ul>\s*<ul>/gim, ''); // merge adjacent lists

  // Bold **text**
  md = md.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

  // Italic *text* or _text_
  md = md.replace(/(^|[^*])\*(?!\*)([^*]+)\*(?!\*)/g, '$1<em>$2</em>');
  md = md.replace(/(^|[^_])_(?!_)([^_]+)_(?!_)/g, '$1<em>$2</em>');

  // Inline code `code`
  md = md.replace(/`([^`\n]+)`/g, "<code class='inline'>$1</code>");

  // Links [text](url)
  md = md.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

  // Line breaks
  md = md.replace(/\n{2,}/g, "</p><p>");
  md = md.replace(/\n/g, "<br>");

  // Wrap paragraphs
  md = `<p>${md}</p>`;
  return md;
}


  function appendMsg(text, role) {
    const div = document.createElement("div");
    div.className = `msg ${role}`;
    div.innerHTML = markdownToHTML(text);
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function showTyping() {
    if (document.getElementById("typingIndicator")) return;
    const wrap = document.createElement("div");
    wrap.className = "msg assistant";
    wrap.id = "typingIndicator";
    wrap.innerHTML = '<div class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function hideTyping() {
    const el = document.getElementById("typingIndicator");
    if (el) el.remove();
  }

  // Robust worker caller: returns { output_text, error }
  async function callWorker(baseUrl, provider, messages) {
    try {
      const res = await fetch(baseUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ provider, messages }),
      });

      // try to parse json safely
      const txt = await res.text();
      try {
        return JSON.parse(txt);
      } catch (e) {
        // If parsing fails, return a coherent error object so caller can decide
        return { error: "Invalid JSON from worker", raw: txt };
      }
    } catch (err) {
      return { error: err.message || String(err) };
    }
  }

  async function sendMessage(text) {
    const model = providerSel.value;
    appendMsg(text, "user");
    showTyping();

    // Try primary first
    const primaryResp = await callWorker(PRIMARY_API, model, [{ role: "user", content: text }]);
    hideTyping();

    // Normalize primary output_text if present
    const primaryText = primaryResp && typeof primaryResp.output_text === "string" ? primaryResp.output_text : null;

    // ONLY trigger backup when primary explicitly says "⚠️ No reply" (or starts with it)
    const primarySaysNoReply = primaryText && primaryText.trim().startsWith("⚠️ No reply");

    if (primarySaysNoReply) {
      // show system message only after we confirm backup succeeds
      showTyping();
      const backupResp = await callWorker(BACKUP_API, model, [{ role: "user", content: text }]);
      hideTyping();

      const backupText = backupResp && typeof backupResp.output_text === "string" ? backupResp.output_text : null;

      if (backupText) {
        // Friendly display of which model we're switching to (user asked for "gpt-4o mini" text)
        const friendlyModelName = (model || "gpt-4o-mini").replace(/-/g, " ");
        appendMsg(`⚠️ Primary server failed — using backup. ${friendlyModelName}`, "assistant");
        appendMsg(backupText, "assistant");
        return;
      } else {
        // backup failed — show both errors (primary had No reply, backup errored)
        const backupErr = backupResp?.error || "No response from backup";
        appendMsg(`❌ Both servers failed: ${backupErr}`, "assistant");
        return;
      }
    }

    // If primary returned a normal reply (even if primaryResp.error exists but output_text present),
    // show that. If there was an error and no output_text, treat as a failure message.
    if (primaryText) {
      appendMsg(primaryText, "assistant");
    } else {
      const errMsg = primaryResp?.error || "Unknown error from primary";
      appendMsg(`❌ Primary server error: ${errMsg}`, "assistant");
    }
  }

  sendBtn.onclick = () => {
    const txt = promptEl.value.trim();
    if (!txt) return;
    promptEl.value = "";
    sendMessage(txt);
  };

  promptEl.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  clearBtn.onclick = () => (chatEl.innerHTML = "");
})();
</script>
</body>
</html>
