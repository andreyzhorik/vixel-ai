<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VIXEL AI</title>
<style>
  /* =============================
     Root variables & theme
     ============================= */
  :root {
    --bg: #000000;
    --panel: #3D0000;
    --accent: #FF0000;
    --accent-soft: #3D0000;
    --muted: #b89494;
    --text: #e5eaf5;
    --radius: 14px;
    --shadow: 0 10px 30px rgba(0,0,0,.3);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  }

  /* =============================
     Global styles
     ============================= */
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, var(--bg), #3D0000);
    color: var(--text);
  }

  /* =============================
     App container
     ============================= */
  .app {
    width: 95%;
    max-width: 900px;
    height: 90vh;
    background: var(--panel);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.04);
  }

  /* =============================
     Header / branding / controls
     ============================= */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }

  .brand {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .logo {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent-soft));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    color: #fff;
  }

  .title {
    font-weight: 700;
    color: var(--accent);
  }

  .controls {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  select {
    background: rgba(255,255,255,0.03);
    color: var(--text);
    border: 1px solid rgba(255,255,255,0.06);
    padding: 8px 10px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
  }

  .btn {
    background: var(--accent);
    border: none;
    color: #fff;
    padding: 8px 12px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
  }

  /* =============================
     Chat window
     ============================= */
  .chat {
    flex: 1;
    overflow: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .msg {
    max-width: 78%;
    padding: 12px 16px;
    border-radius: 12px;
    line-height: 1.5;
    box-shadow: 0 6px 18px rgba(0,0,0,0.3);
    word-break: break-word;
    white-space: pre-wrap;
  }

  .msg.user {
    align-self: flex-end;
    background: linear-gradient(135deg, var(--accent-soft), var(--accent));
    color: #fff;
    border-bottom-right-radius: 6px;
  }

  .msg.assistant {
    align-self: flex-start;
    background: #111827;
    color: var(--text);
    border-bottom-left-radius: 6px;
  }

  /* =============================
     Inline and block code styling
     ============================= */
  .msg code {
    background: #1e293b;
    padding: 2px 5px;
    border-radius: 4px;
    font-family: monospace;
    color: #93c5fd;
  }

  .msg pre {
    background: #1e293b;
    padding: 10px;
    border-radius: 8px;
    overflow-x: auto;
    font-family: monospace;
    color: #93c5fd;
    position: relative;
  }

  /* =============================
     Footer & input
     ============================= */
  footer {
    display: flex;
    gap: 10px;
    padding: 14px;
    border-top: 1px solid rgba(255,255,255,0.04);
    background: #3D0000;
  }

  textarea {
    flex: 1;
    min-height: 56px;
    border-radius: 10px;
    padding: 12px;
    background: #950101;
    border: 1px solid rgba(255,255,255,0.06);
    color: var(--text);
    resize: none;
    font-size: 14px;
    font-family: inherit;
  }

  button.send {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 12px 18px;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
  }

  .small {
    font-size: 12px;
    color: var(--muted);
  }

  /* =============================
     Typing indicator
     ============================= */
  .typing {
    width: 48px;
    height: 18px;
    border-radius: 12px;
    background: #162037;
    display: flex;
    gap: 6px;
    align-items: center;
    padding: 6px;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--muted);
    animation: blink 1s infinite;
  }

  .dot:nth-child(2) { animation-delay: .15s; }
  .dot:nth-child(3) { animation-delay: .3s; }

  @keyframes blink {
    0% { opacity: .15; }
    50% { opacity: 1; }
    100% { opacity: .15; }
  }

  /* =============================
     Assistant message enhancements
     ============================= */
  .msg.assistant code.inline {
    background: #1a2335;
    color: #facc15;
    padding: 2px 5px;
    border-radius: 5px;
    font-family: monospace;
  }

  .msg.assistant pre code {
    display: block;
    background: #0f172a;
    padding: 10px;
    border-radius: 10px;
    overflow-x: auto;
  }

  .msg.assistant h1,
  .msg.assistant h2,
  .msg.assistant h3,
  .msg.assistant h4,
  .msg.assistant h5,
  .msg.assistant h6 {
    margin: 6px 0;
    color: #60a5fa;
  }

  .msg.assistant blockquote {
    border-left: 3px solid #3b82f6;
    margin: 8px 0;
    padding-left: 10px;
    color: #9ca3af;
    font-style: italic;
  }

  .msg.assistant ul,
  .msg.assistant ol {
    margin: 4px 0 4px 20px;
  }

  .msg.assistant hr {
    border: 0;
    border-top: 1px solid #334155;
    margin: 10px 0;
  }

  /* =============================
     Copy button
     ============================= */
  .copy-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(30,41,59,0.95);
    color: #fff;
    border: none;
    padding: 4px 8px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    z-index: 10;
    opacity: 0.85;
  }

  /* =============================
     Responsive
     ============================= */
  @media (max-width: 640px) {
    .app {
      height: 100vh;
      border-radius: 0;
    }
  }

</style>
</head>
<body>

<div class="app">
  <header>
    <div class="brand">
      <div class="logo">V</div>
      <div>
        <div class="title">VIXEL AI</div>
        <div class="small">vixel ai with chat gpt and gemini</div>
      </div>
    </div>
    <div class="controls">
      <label class="small" for="provider">Model</label>
      <select id="provider"></select>
      <button class="btn" id="clearBtn">Clear</button>
    </div>
  </header>

  <main class="chat" id="chat"></main>

  <footer>
    <textarea id="prompt" placeholder="Type your message..."></textarea>
    <button class="send" id="sendBtn">Send</button>
  </footer>
</div>

<script>
(() => {
  // --------------------------
  // API Endpoints
  // --------------------------
  const PRIMARY_API = "https://plain-pine-b32a.mrviktor2426.workers.dev/";
  const BACKUP_API  = "https://wispy-voice-741d.mrviktor2426.workers.dev/";

  const providerSel = document.getElementById("provider");
  const chatEl = document.getElementById("chat");
  const promptEl = document.getElementById("prompt");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");

  // --------------------------
// Invite code system (client)
// --------------------------
const VERIFY_URL = `${PRIMARY_API}?verify_code=`;
let inviteCode = localStorage.getItem("inviteCode");
let isVerified = localStorage.getItem("isVerified") === "true";

async function verifyInvite() {
  const code = prompt("Enter invite code to unlock locked models:");
  if (!code) return alert("‚ùå No code entered.");
  try {
    const res = await fetch(VERIFY_URL + encodeURIComponent(code));
    const data = await res.json();
    if (data.valid) {
      localStorage.setItem("inviteCode", code);
      localStorage.setItem("isVerified", "true");
      alert("‚úÖ Invite code accepted! Locked models are now unlocked.");
      isVerified = true;
      populateModels();
    } else {
      alert("‚ùå This invite code is invalid or already used.");
    }
  } catch (err) {
    alert("‚ö†Ô∏è Error verifying code: " + err.message);
  }
}


  // --------------------------
  // Populate model dropdown
  // --------------------------
  function populateModels() {
    providerSel.innerHTML = `
      <option value="gpt-4o-mini">GPT-4o-mini (FAST ‚è©)</option>
      <option value="gpt-4.1-mini" ${!isVerified ? 'data-locked="true"' : ''}>
        GPT-4.1-mini ${!isVerified ? '(üîí SMART ü§î)' : '(SMART ü§î)'}
      </option>
      <option value="gemini-2.5-flash">Gemini 2.5 Flash (NERT ü§ì)</option>
      <option value="gemini-2.5-pro" ${!isVerified ? 'data-locked="true"' : ''}>
        Gemini 2.5 Pro ${!isVerified ? '(üîí ELITE üß†)' : '(ELITE üß†)'}
      </option>
    `;
  }

  populateModels();

  // --------------------------
// Markdown ‚Üí HTML (Full version)
// --------------------------
function markdownToHTML(md) {
  if (!md) return "";

  // escape HTML first
  md = md.replace(/</g, "&lt;").replace(/>/g, "&gt;");

  // --------------------------
  // Handle code blocks first
  // --------------------------
  const codeBlocks = [];
  md = md.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
    const id = codeBlocks.length;
    codeBlocks.push({ lang, code });
    return `@@CODE_BLOCK_${id}@@`;
  });

  // --------------------------
  // Footnotes
  // --------------------------
  const footnotes = {};
  md = md.replace(/^\[\^(\w+)\]: (.*)$/gim, (_, name, text) => {
    footnotes[name] = text;
    return "";
  });

  // --------------------------
  // Headings
  // --------------------------
  md = md
    .replace(/^###### (.*)$/gim, "<h6>$1</h6>")
    .replace(/^##### (.*)$/gim, "<h5>$1</h5>")
    .replace(/^#### (.*)$/gim, "<h4>$1</h4>")
    .replace(/^### (.*)$/gim, "<h3>$1</h3>")
    .replace(/^## (.*)$/gim, "<h2>$1</h2>")
    .replace(/^# (.*)$/gim, "<h1>$1</h1>");

  // --------------------------
  // Horizontal rules
  // --------------------------
  md = md.replace(/(^|\n)([-*_]){3,}(?=\n|$)/g, "\n<hr>\n");

  // --------------------------
  // Blockquotes
  // --------------------------
  md = md.replace(/(^|\n)> (.*)/g, "$1<blockquote>$2</blockquote>");

  // --------------------------
  // Lists
  // --------------------------
  md = md
    .replace(/^\s*[-*+] (.*)/gim, "<ul><li>$1</li></ul>")
    .replace(/<\/ul>\s*<ul>/gim, "")
    .replace(/^\s*\d+\. (.*)/gim, "<ol><li>$1</li></ol>")
    .replace(/<\/ol>\s*<ol>/gim, "");

  // --------------------------
  // Tables
  // --------------------------
  md = md.replace(/^\|(.+)\|\n\|([-\s|:]+)\|\n((?:\|.*\|\n?)*)/gm, (match, header, divider, rows) => {
    const headers = header.split("|").map(h => `<th>${h.trim()}</th>`).join("");
    const body = rows
      .trim()
      .split("\n")
      .map(r => {
        const cols = r.split("|").map(c => `<td>${c.trim()}</td>`).join("");
        return `<tr>${cols}</tr>`;
      })
      .join("");
    return `<table><thead><tr>${headers}</tr></thead><tbody>${body}</tbody></table>`;
  });

  // --------------------------
  // Inline formatting
  // --------------------------
  md = md
    .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")       // bold
    .replace(/\*(.*?)\*/g, "<i>$1</i>")           // italic
    .replace(/__(.*?)__/g, "<u>$1</u>")           // underline
    .replace(/~~(.*?)~~/g, "<s>$1</s>")           // strikethrough
    .replace(/`([^`]+)`/g, "<code>$1</code>")     // inline code
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>'); // links

  // --------------------------
  // Footnote refs
  // --------------------------
  md = md.replace(/\[\^(\w+)\]/g, (_, name) => {
    if (footnotes[name]) {
      return `<sup id="fnref-${name}"><a href="#fn-${name}">[${name}]</a></sup>`;
    }
    return "";
  });

  // --------------------------
  // Line breaks
  // --------------------------
  md = md.replace(/\n{2,}/g, "</p><p>").replace(/\n/g, "<br>");

  // --------------------------
  // Restore code blocks
  // --------------------------
  md = md.replace(/@@CODE_BLOCK_(\d+)@@/g, (_, i) => {
    const { lang, code } = codeBlocks[+i];
    const languageClass = lang ? ` class="language-${lang}"` : "";
    return `<pre><code${languageClass}>${code}</code></pre>`;
  });

  // --------------------------
  // Append footnote section
  // --------------------------
  if (Object.keys(footnotes).length > 0) {
    md += `<hr><section class="footnotes"><ol>`;
    for (const [name, text] of Object.entries(footnotes)) {
      md += `<li id="fn-${name}">${text} <a href="#fnref-${name}">‚Ü©</a></li>`;
    }
    md += `</ol></section>`;
  }

  return `<p>${md}</p>`;
}


  // --------------------------
  // Append message + copy btn
  // --------------------------
  function appendMsg(text, role) {
    const div = document.createElement("div");
    div.className = `msg ${role}`;
    div.innerHTML = markdownToHTML(text);
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
    addCopyButtonsForNode(div);
  }

  function addCopyButtonsForNode(root) {
    root.querySelectorAll("pre").forEach(pre => {
      if (pre.dataset.copyAttached) return;
      const code = pre.querySelector("code");
      if (!code) return;
      const btn = document.createElement("button");
      btn.className = "copy-btn";
      btn.textContent = "üìã Copy";
      btn.title = "Copy code";
      pre.style.position = "relative";
      pre.appendChild(btn);
      btn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(code.innerText);
          btn.textContent = "‚úÖ Copied";
          setTimeout(() => (btn.textContent = "üìã Copy"), 1200);
        } catch {
          btn.textContent = "‚ùå";
          setTimeout(() => (btn.textContent = "üìã Copy"), 1200);
        }
      });
      pre.dataset.copyAttached = "1";
    });
  }

  const mo = new MutationObserver(m => {
    m.forEach(r => r.addedNodes.forEach(n => n.nodeType === 1 && addCopyButtonsForNode(n)));
  });
  mo.observe(chatEl, { childList: true, subtree: true });

  // --------------------------
  // Worker call
  // --------------------------
  async function callWorker(baseUrl, provider, messages) {
    try {
      const res = await fetch(baseUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ provider, messages }),
      });
      const txt = await res.text();
      try {
        return JSON.parse(txt);
      } catch {
        return { error: "Invalid JSON", raw: txt };
      }
    } catch (err) {
      return { error: err.message || String(err) };
    }
  }

  // --------------------------
  // Send message workflow
  // --------------------------
  async function sendMessage(text) {
    const model = providerSel.value;
    const isLocked = providerSel.selectedOptions[0]?.dataset.locked === "true";

    if (isLocked && !isVerified) {
      appendMsg(`üîí "${model}" is locked. Enter invite code to unlock.`, "assistant");
      verifyInvite();
      return;
    }

    appendMsg(text, "user");
    showTyping();

    let resp = await callWorker(PRIMARY_API, model, [{ role: "user", content: text }]);
    hideTyping();

    let reply = resp?.output_text;
    if (!reply || reply.trim().startsWith("‚ö†Ô∏è No reply") || resp.error) {
      appendMsg("‚ö†Ô∏è Primary failed ‚Äî trying backup...", "assistant");
      showTyping();
      resp = await callWorker(BACKUP_API, model, [{ role: "user", content: text }]);
      hideTyping();
      reply = resp?.output_text;
    }

    if (reply) appendMsg(reply, "assistant");
    else appendMsg(`‚ùå Error: ${resp?.error || "No valid response"}`, "assistant");
  }

  // --------------------------
  // Typing bubble
  // --------------------------
  function showTyping() {
    if (document.getElementById("typingIndicator")) return;
    const wrap = document.createElement("div");
    wrap.className = "msg assistant";
    wrap.id = "typingIndicator";
    wrap.innerHTML =
      '<div class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }
  function hideTyping() {
    const el = document.getElementById("typingIndicator");
    if (el) el.remove();
  }

  // --------------------------
  // Events
  // --------------------------
  sendBtn.onclick = () => {
    const txt = promptEl.value.trim();
    if (!txt) return;
    promptEl.value = "";
    sendMessage(txt);
  };

  promptEl.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  clearBtn.onclick = () => chatEl.innerHTML = "";

})();
</script>
</body>
</html>
